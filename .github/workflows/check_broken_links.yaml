name: Link checking

on:
  workflow_dispatch:

jobs:
  link-check:
    strategy:
      matrix:
        url: [
          "https://docs.stakater.com/saap2/index.html"
        ]
    runs-on: ubuntu-latest
    steps:
      # Don't stop the workflow if there are errors, but continue and send a message
      # The file name of the link check result has to be unique for each job since the jobs run in parallel
      - name: Check links
        id: link_check
        continue-on-error: true
        run: |
          RANDOM_FILE_NAME=${RANDOM}.txt
          echo "RANDOM_FILE_NAME=$RANDOM_FILE_NAME" >> "$GITHUB_OUTPUT"
          docker run --rm -u $(id -u):$(id -g) -v "$PWD":/mnt ghcr.io/linkchecker/linkchecker:8ae3783 -r 1 --check-extern -F text/$RANDOM_FILE_NAME ${{ matrix.url }}
      # The results have to be output in a separate step because if the link check fails, that step will stop right after the failure
      # - name: Link check result
      #   id: link_check_result
      #   run: |
      #     echo 'link_result<<EOF' >> $GITHUB_OUTPUT
      #     echo "$(cat ${{ steps.link_check.outputs.RANDOM_FILE_NAME }})" >> $GITHUB_OUTPUT
      #     echo 'EOF' >> $GITHUB_OUTPUT
      # Only send message if there are errors
      - if: ${{ steps.link_check.outcome == 'failure' }}
        name: Send broken link check result to chat
        run: |
          echo "some text and $(cat ${{ steps.link_check.outputs.RANDOM_FILE_NAME }})"
